<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannon Requirements Cloud</title>
    <meta name="Description" content="U.S. Army Corps of Engineers St. Louis District Home Page" />
    <link rel="stylesheet" href="css/body.css" />
    <link rel="stylesheet" href="css/breadcrumbs.css" />
    <link rel="stylesheet" href="css/jumpMenu.css" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="js/main.js"></script>
    <script src="js/libraries/moment.min.js"></script>
    <script src="js/libraries/moment-timezone-with-data.js"></script>
    <script src="js/libraries/chart.js"></script>
    <script src="js/libraries/chartjs-adapter-moment.min.js"></script>
</head>

<body>
    <div id="page-container">
        <header id="header">
            <!--Header content populated here by JavaScript Tag at end of body -->
        </header>
        <div class="page-wrap">
            <div class="container-fluid">
                <div id="breadcrumbs">
                </div>
                <div class="page-content">
                    <sidebar id="sidebar"></sidebar>
                    <div id="topPane" class="col-md backend-cp-collapsible">
                        <div class="box-usace">
                            <h2 class="box-header-striped">
                                <span class="titleLabel title">Cannon Requirements</span>
                                <span class="rss"></span>
                            </h2>
                            <div class="box-content" style="background-color:white;margin:auto">
                                <div class="content">
                                    <div class="status"></div>
                                    <button id="cda-btn" disabled>Login</button>
                                    <form id="myForm" onsubmit="prepareEmail(event)">
                                        <!-- SWPA’s Scheduled Generation -->
                                        <label for="swpa_scheduled_generation">
                                            <a href="../chart/index.html?office=MVS&cwms_ts_id=Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.swpa-scheduled-generation&lookforward=0&lookback=7"
                                                target="_blank">SWPA’s Scheduled Generation (dsf)</a>:
                                        </label>
                                        <input type="number" name="swpa_scheduled_generation"
                                            id="swpa_scheduled_generation" required>

                                        <label for="swpa_scheduled_generation_power">
                                            <a href="../chart/index.html?office=MVS&cwms_ts_id=Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.swpa-scheduled-generation&lookforward=0&lookback=7"
                                                target="_blank">SWPA’s Scheduled Generation (MW)</a>:
                                        </label>
                                        <input type="number" name="swpa_scheduled_generation_power"
                                            id="swpa_scheduled_generation_power" required>

                                        <!-- USACE Maximum -->
                                        <label for="usace_maximum">
                                            <a href="../chart/index.html?office=MVS&cwms_ts_id=Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-maximum&lookforward=0&lookback=7"
                                                target="_blank">USACE Maximum (dsf)</a>:
                                        </label>
                                        <input type="number" name="usace_maximum" id="usace_maximum" required>

                                        <label for="usace_maximum_power">
                                            <a href="../chart/index.html?office=MVS&cwms_ts_id=Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-maximum&lookforward=0&lookback=7"
                                                target="_blank">USACE Maximum (MW)</a>:
                                        </label>
                                        <input type="number" name="usace_maximum_power" id="usace_maximum_power"
                                            required>

                                        <!-- USACE Minimum -->
                                        <label for="usace_minimum">
                                            <a href="../chart/index.html?office=MVS&cwms_ts_id=Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-minimum&lookforward=0&lookback=7"
                                                target="_blank">USACE Minimum (dsf)</a>:
                                        </label>
                                        <input type="number" name="usace_minimum" id="usace_minimum" required>

                                        <label for="usace_minimum_power">
                                            <a href="../chart/index.html?office=MVS&cwms_ts_id=Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-minimum&lookforward=0&lookback=7"
                                                target="_blank">USACE Minimum (MW)</a>:
                                        </label>
                                        <input type="number" name="usace_minimum_power" id="usace_minimum_power"
                                            required>

                                        <!-- USACE Target -->
                                        <label for="usace_target">
                                            <a href="../chart/index.html?office=MVS&cwms_ts_id=Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-target&lookforward=0&lookback=7"
                                                target="_blank">USACE Target (dsf)</a>:
                                        </label>
                                        <input type="number" name="usace_target" id="usace_target" required>

                                        <label for="usace_target_power">
                                            <a href="../chart/index.html?office=MVS&cwms_ts_id=Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-target&lookforward=0&lookback=7"
                                                target="_blank">USACE Target (MW)</a>:
                                        </label>
                                        <input type="number" name="usace_target_power" id="usace_target_power" required>

                                        <input type="submit" id="prepareEmailButton" value="Save Your Data First" disabled>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="returnTop" title="Return to Top of Page">Top</button>
        </div>
    </div>
    <footer id="footer">
        <!--Footer content populated here by script tag at end of body -->
    </footer>
    <script src="js/libraries/jQuery-3.3.6.min.js"></script>
    <script defer>
        // When the document has loaded pull in the page header and footer skins
        $(document).ready(function () {
            $('#header').load('templates/DISTRICT.header.html');
            $('#footer').load('templates/DISTRICT.footer.html');
        })
    </script>
</body>

</html>

<script defer type="module">
    // Utility function to get date with specific time set
    function getDateWithTimeSet(daysToAdd, hours, minutes) {
        let date = new Date();
        date.setDate(date.getDate() + daysToAdd);
        date.setHours(hours, minutes, 0, 0); // Set hours, minutes, seconds, milliseconds
        return date.getTime();
    }

    // Function to write timeseries data
    async function writeTS(payload) {
        if (!payload) throw new Error("You must specify a payload!");

        try {
            const response = await fetch("https://wm.mvs.ds.usace.army.mil/mvs-data/timeseries?store-rule=REPLACE%20ALL", {
                method: "POST",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json;version=2",
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorText}`);
            }

            return true;

        } catch (error) {
            console.error('Error writing timeseries:', error);
            throw error;
        }
    }

    // Function to check if user is logged in
    async function isLoggedIn() {
        try {
            const response = await fetch("https://wm.mvs.ds.usace.army.mil/mvs-data/auth/keys", {
                method: "GET"
            });

            if (response.status === 401) return false;

            console.log('Status:', response.status);
            return true;

        } catch (error) {
            console.error('Error checking login status:', error);
            return false;
        }
    }

    // Function to handle login
    async function loginCDA() {
        if (await isLoggedIn()) return true;

        // Redirect to login page
        window.location.href = `https://wm.mvs.ds.usace.army.mil:8243/CWMSLogin/login?OriginalLocation=${encodeURIComponent(window.location.href)}`;
    }

    // DOM elements
    const statusBtn = document.querySelector(".status");
    const cdaBtn = document.getElementById("cda-btn");
    const prepareEmailButton = document.getElementById('prepareEmailButton');

    // Controller for login state
    async function loginStateController() {
        cdaBtn.disabled = true;
        if (await isLoggedIn()) {
            cdaBtn.innerText = "Save";
        } else {
            cdaBtn.innerText = "Login";
        }
        cdaBtn.disabled = false;
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Setup event listeners
        cdaBtn.onclick = async () => {
            if (cdaBtn.innerText === "Login") {
                const loginResult = await loginCDA();
                if (loginResult) {
                    cdaBtn.innerText = "Submit";
                } else {
                    statusBtn.innerText = "Failed to Login!";
                }
            } else {
                try {
                    if ("swpa_scheduled_generation" === "swpa_scheduled_generation") {
                        // Get value from swpa_scheduled_generation
                        const swpaScheduledGenerationInput = document.getElementById('swpa_scheduled_generation').value;
                        let swpaScheduledGenerationPayload;

                        if (swpaScheduledGenerationInput) {
                            swpaScheduledGenerationPayload = {
                                "name": "Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.swpa-scheduled-generation",
                                "office-id": "MVS",
                                "units": "cfs",
                                "values": [
                                    [getDateWithTimeSet(0, 6, 0), parseFloat(swpaScheduledGenerationInput), 0]
                                ]
                            };
                        } else {
                            statusBtn.innerText = "No value entered!";
                            return;
                        }

                        // Get value from swpa_scheduled_generation_power
                        const swpaScheduledGenerationPowerInput = document.getElementById('swpa_scheduled_generation_power').value;
                        let swpaScheduledGenerationPowerPayload;

                        if (swpaScheduledGenerationPowerInput) {
                            swpaScheduledGenerationPowerPayload = {
                                "name": "Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.swpa-scheduled-generation",
                                "office-id": "MVS",
                                "units": "MW",
                                "values": [
                                    [getDateWithTimeSet(0, 6, 0), parseFloat(swpaScheduledGenerationPowerInput), 0]
                                ]
                            };
                        } else {
                            statusBtn.innerText = "No value entered!";
                            return;
                        }

                        // Write timeseries to CDA
                        await writeTS(swpaScheduledGenerationPayload);
                        await writeTS(swpaScheduledGenerationPowerPayload);
                    }

                    if ("usace_maximum" === "usace_maximum") {
                        // Get value from usace_maximum
                        const usaceMaximumInput = document.getElementById('usace_maximum').value;
                        let usaceMaximumPayload;

                        if (usaceMaximumInput) {
                            usaceMaximumPayload = {
                                "name": "Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-maximum",
                                "office-id": "MVS",
                                "units": "cfs",
                                "values": [
                                    [getDateWithTimeSet(0, 6, 0), parseFloat(usaceMaximumInput), 0]
                                ]
                            };
                        } else {
                            statusBtn.innerText = "No value entered!";
                            return;
                        }

                        // Get value from usace_maximum_power
                        const usaceMaximumPowerInput = document.getElementById('usace_maximum_power').value;
                        let usaceMaximumPowerPayload;

                        if (usaceMaximumPowerInput) {
                            usaceMaximumPowerPayload = {
                                "name": "Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-maximum",
                                "office-id": "MVS",
                                "units": "MW",
                                "values": [
                                    [getDateWithTimeSet(0, 6, 0), parseFloat(usaceMaximumPowerInput), 0]
                                ]
                            };
                        } else {
                            statusBtn.innerText = "No value entered!";
                            return;
                        }

                        // Write timeseries to CDA
                        await writeTS(usaceMaximumPayload);
                        await writeTS(usaceMaximumPowerPayload);
                    }

                    if ("usace_minimum" === "usace_minimum") {
                        // Get value from usace_minimum
                        const usaceMinimumInput = document.getElementById('usace_minimum').value;
                        let usaceMinimumPayload;

                        if (usaceMinimumInput) {
                            usaceMinimumPayload = {
                                "name": "Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-minimum",
                                "office-id": "MVS",
                                "units": "cfs",
                                "values": [
                                    [getDateWithTimeSet(0, 6, 0), parseFloat(usaceMinimumInput), 0]
                                ]
                            };
                        } else {
                            statusBtn.innerText = "No value entered!";
                            return;
                        }

                        // Get value from usace_minimum_power
                        const usaceMinimumPowerInput = document.getElementById('usace_minimum_power').value;
                        let usaceMinimumPowerPayload;

                        if (usaceMinimumPowerInput) {
                            usaceMinimumPowerPayload = {
                                "name": "Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-minimum",
                                "office-id": "MVS",
                                "units": "MW",
                                "values": [
                                    [getDateWithTimeSet(0, 6, 0), parseFloat(usaceMinimumPowerInput), 0]
                                ]
                            };
                        } else {
                            statusBtn.innerText = "No value entered!";
                            return;
                        }

                        // Write timeseries to CDA
                        await writeTS(usaceMinimumPayload);
                        await writeTS(usaceMinimumPowerPayload);
                    }

                    if ("usace_target" === "usace_target") {
                        // Get value from usace_target
                        const usaceTargetInput = document.getElementById('usace_target').value;
                        let usaceTargetPayload;

                        if (usaceTargetInput) {
                            usaceTargetPayload = {
                                "name": "Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-target",
                                "office-id": "MVS",
                                "units": "cfs",
                                "values": [
                                    [getDateWithTimeSet(0, 6, 0), parseFloat(usaceTargetInput), 0]
                                ]
                            };
                        } else {
                            statusBtn.innerText = "No value entered!";
                            return;
                        }

                        // Get value from usace_target_power
                        const usaceTargetPowerInput = document.getElementById('usace_target_power').value;
                        let usaceTargetPowerPayload;

                        if (usaceTargetPowerInput) {
                            usaceTargetPowerPayload = {
                                "name": "Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-target",
                                "office-id": "MVS",
                                "units": "MW",
                                "values": [
                                    [getDateWithTimeSet(0, 6, 0), parseFloat(usaceTargetPowerInput), 0]
                                ]
                            };
                        } else {
                            statusBtn.innerText = "No value entered!";
                            return;
                        }

                        // Write timeseries to CDA
                        await writeTS(usaceTargetPayload);
                        await writeTS(usaceTargetPowerPayload);
                    }

                    statusBtn.innerText = "Write successful!";

                    // Show success alert
                    alert("Write successful!");

                    // Enable the submit button
                    prepareEmailButton.disabled = false;
                    prepareEmailButton.value = "Email Prepared"; // Change text before enabling
                } catch (error) {
                    statusBtn.innerText = "Failed to write data!";
                }
            }
        };

        // Initial state check
        loginStateController();

        // Setup periodic login state check
        setInterval(async () => {
            loginStateController();
        }, 10000); // Time in milliseconds
    });

    var office = "MVS";

    // Get current date and time
    const currentDateTime = new Date();
    // console.log('currentDateTime:', currentDateTime);

    // Subtract two hours from current date and time
    const currentDateTimeMinus2Hours = subtractHoursFromDate(currentDateTime, 2);
    // console.log('currentDateTimeMinus2Hours :', currentDateTimeMinus2Hours);

    // Subtract two hours from current date and time
    const currentDateTimeMinus8Hours = subtractHoursFromDate(currentDateTime, 8);
    // console.log('currentDateTimeMinus8Hours :', currentDateTimeMinus8Hours);

    // Subtract thirty hours from current date and time
    const currentDateTimeMinus30Hours = subtractHoursFromDate(currentDateTime, 64);
    // console.log('currentDateTimeMinus30Hours :', currentDateTimeMinus30Hours);

    // Add thirty hours to current date and time
    const currentDateTimePlus30Hours = plusHoursFromDate(currentDateTime, 30);
    // console.log('currentDateTimePlus30Hours :', currentDateTimePlus30Hours);

    // Add four days to current date and time
    const currentDateTimePlus4Days = addDaysToDate(currentDateTime, 4);
    // console.log('currentDateTimePlus4Days :', currentDateTimePlus4Days);

    // Function to get the last non null value from values array
    function getLastNonNullValue(data) {
        // Iterate over the values array in reverse
        for (let i = data.values.length - 1; i >= 0; i--) {
            // Check if the value at index i is not null
            if (data.values[i][1] !== null) {
                // Return the non-null value as separate variables
                return {
                    timestamp: data.values[i][0],
                    value: data.values[i][1],
                    qualityCode: data.values[i][2]
                };
            }
        }
        // If no non-null value is found, return null
        return null;
    }

    // Function to convert timestamp to specified format
    function formatNWSDate(timestamp) {
        const date = new Date(timestamp);
        const mm = String(date.getMonth() + 1).padStart(2, '0'); // Month
        const dd = String(date.getDate()).padStart(2, '0'); // Day
        const yyyy = date.getFullYear(); // Year
        const hh = String(date.getHours()).padStart(2, '0'); // Hours
        const min = String(date.getMinutes()).padStart(2, '0'); // Minutes
        return `${mm}-${dd}-${yyyy} ${hh}:${min}`;
    }

    // Function to find the c_count for each interval id
    function calculateCCount(tsid) {
        // Split the string at the period
        const splitString = tsid.split('.');

        // Access the fifth element
        const forthElement = splitString[3];
        // console.log("forthElement = ", forthElement);

        // Initialize c_count variable
        let c_count;

        // Set c_count based on the value of firstTwoCharacters
        switch (forthElement) {
            case "15Minutes":
                c_count = 96;
                break;
            case "10Minutes":
                c_count = 144;
                break;
            case "30Minutes":
                c_count = 48;
                break;
            case "1Hour":
                c_count = 24;
                break;
            case "6Hours":
                c_count = 4;
                break;
            case "~2Hours":
                c_count = 12;
                break;
            case "5Minutes":
                c_count = 288;
                break;
            case "~1Day":
                c_count = 1;
                break;
            default:
                // Default value if forthElement doesn't match any case
                c_count = 0;
        }

        return c_count;
    }

    // Function to convert cda date time to mm-dd-yyyy 24hh:mi
    function formatTimestampToString(timestampLast) {
        const date = new Date(timestampLast);
        const formattedDate = `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}-${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        return formattedDate;
    }

    // Function to get current data time
    function subtractHoursFromDate(date, hoursToSubtract) {
        return new Date(date.getTime() - (hoursToSubtract * 60 * 60 * 1000));
    }

    // Function to get current data time
    function plusHoursFromDate(date, hoursToSubtract) {
        return new Date(date.getTime() + (hoursToSubtract * 60 * 60 * 1000));
    }

    // Function to add days to a given date
    function addDaysToDate(date, days) {
        return new Date(date.getTime() + (days * 24 * 60 * 60 * 1000));
    }

    function fetchSwpaScheduledGenerationInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours) {
        // Fetch the time series data from the API using the determined query string
        let urlStage = null;
        urlStage = `https://coe-${office}uwa04${office.toLocaleLowerCase()}.${office.toLocaleLowerCase()}.usace.army.mil/${office.toLocaleLowerCase()}-data/timeseries?name=Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.swpa-scheduled-generation&begin=${currentDateTimeMinus30Hours.toISOString()}&end=${currentDateTime.toISOString()}&office=${office}`;

        // console.log("urlStage = ", urlStage);
        fetch(urlStage, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;version=2'
            }
        })
            .then(response => {
                // Check if the response is ok
                if (!response.ok) {
                    // If not, throw an error
                    throw new Error('Network response was not ok');
                }
                // If response is ok, parse it as JSON
                return response.json();
            })
            .then(stage => {
                console.log("stage:", stage);

                // Convert timestamps in the JSON object
                stage.values.forEach(entry => {
                    entry[0] = formatNWSDate(entry[0]); // Update timestamp
                });

                // Output the updated JSON object
                // // console.log(JSON.stringify(stage, null, 2));

                // console.log("stageFormatted = ", stage);

                // Get the last non-null value from the stage data
                const lastNonNullValue = getLastNonNullValue(stage);
                // console.log("lastNonNullValue:", lastNonNullValue);

                // Check if a non-null value was found
                if (lastNonNullValue !== null) {
                    // Extract timestamp, value, and quality code from the last non-null value
                    var timestampLast = lastNonNullValue.timestamp;
                    var valueLast = parseFloat(lastNonNullValue.value).toFixed(0);
                    var qualityCodeLast = lastNonNullValue.qualityCode;

                    // Log the extracted valueLasts
                    // console.log("timestampLast:", timestampLast);
                    // console.log("valueLast:", valueLast);
                    // console.log("qualityCodeLast:", qualityCodeLast);
                } else {
                    // If no non-null valueLast is found, log a message
                    // console.log("No non-null valueLast found.");
                }

                // Format the last valueLast's timestampLast to a string
                const formattedLastValueTimeStamp = formatTimestampToString(timestampLast);
                // console.log("formattedLastValueTimeStamp = ", formattedLastValueTimeStamp);

                // Create a Date object from the timestampLast
                const timeStampDateObject = new Date(timestampLast);
                // console.log("timeStampDateObject = ", timeStampDateObject);

                // Subtract 24 hours (24 * 60 * 60 * 1000 milliseconds) from the timestampLast date
                const timeStampDateObjectMinus24Hours = new Date(timestampLast - (24 * 60 * 60 * 1000));
                // console.log("timeStampDateObjectMinus24Hours = ", timeStampDateObjectMinus24Hours);

                document.getElementById('swpa_scheduled_generation').value = valueLast;

            })
            .catch(error => {
                // Catch and log any errors that occur during fetching or processing
                console.error("Error fetching or processing data:", error);
            });

    }

    function fetchSwpaScheduledGenerationPowerInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours) {
        // Fetch the time series data from the API using the determined query string
        let urlStage = null;
        urlStage = `https://coe-${office}uwa04${office.toLocaleLowerCase()}.${office.toLocaleLowerCase()}.usace.army.mil/${office.toLocaleLowerCase()}-data/timeseries?name=Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.swpa-scheduled-generation&begin=${currentDateTimeMinus30Hours.toISOString()}&end=${currentDateTime.toISOString()}&office=${office}`;

        // console.log("urlStage = ", urlStage);
        fetch(urlStage, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;version=2'
            }
        })
            .then(response => {
                // Check if the response is ok
                if (!response.ok) {
                    // If not, throw an error
                    throw new Error('Network response was not ok');
                }
                // If response is ok, parse it as JSON
                return response.json();
            })
            .then(stage => {
                console.log("stage:", stage);

                // Convert timestamps in the JSON object
                stage.values.forEach(entry => {
                    entry[0] = formatNWSDate(entry[0]); // Update timestamp
                });

                // Output the updated JSON object
                // // console.log(JSON.stringify(stage, null, 2));

                // console.log("stageFormatted = ", stage);

                // Get the last non-null value from the stage data
                const lastNonNullValue = getLastNonNullValue(stage);
                // console.log("lastNonNullValue:", lastNonNullValue);

                // Check if a non-null value was found
                if (lastNonNullValue !== null) {
                    // Extract timestamp, value, and quality code from the last non-null value
                    var timestampLast = lastNonNullValue.timestamp;
                    var valueLast = parseFloat(lastNonNullValue.value).toFixed(0);
                    var qualityCodeLast = lastNonNullValue.qualityCode;

                    // Log the extracted valueLasts
                    // console.log("timestampLast:", timestampLast);
                    // console.log("valueLast:", valueLast);
                    // console.log("qualityCodeLast:", qualityCodeLast);
                } else {
                    // If no non-null valueLast is found, log a message
                    // console.log("No non-null valueLast found.");
                }

                // Format the last valueLast's timestampLast to a string
                const formattedLastValueTimeStamp = formatTimestampToString(timestampLast);
                // console.log("formattedLastValueTimeStamp = ", formattedLastValueTimeStamp);

                // Create a Date object from the timestampLast
                const timeStampDateObject = new Date(timestampLast);
                // console.log("timeStampDateObject = ", timeStampDateObject);

                // Subtract 24 hours (24 * 60 * 60 * 1000 milliseconds) from the timestampLast date
                const timeStampDateObjectMinus24Hours = new Date(timestampLast - (24 * 60 * 60 * 1000));
                // console.log("timeStampDateObjectMinus24Hours = ", timeStampDateObjectMinus24Hours);

                document.getElementById('swpa_scheduled_generation_power').value = valueLast;

            })
            .catch(error => {
                // Catch and log any errors that occur during fetching or processing
                console.error("Error fetching or processing data:", error);
            });

    }

    fetchSwpaScheduledGenerationInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours);
    fetchSwpaScheduledGenerationPowerInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours);

    function fetchUsaceMaximumInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours) {
        // Fetch the time series data from the API using the determined query string
        let urlStage = null;
        urlStage = `https://coe-${office}uwa04${office.toLocaleLowerCase()}.${office.toLocaleLowerCase()}.usace.army.mil/${office.toLocaleLowerCase()}-data/timeseries?name=Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-maximum&begin=${currentDateTimeMinus30Hours.toISOString()}&end=${currentDateTime.toISOString()}&office=${office}`;

        // console.log("urlStage = ", urlStage);
        fetch(urlStage, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;version=2'
            }
        })
            .then(response => {
                // Check if the response is ok
                if (!response.ok) {
                    // If not, throw an error
                    throw new Error('Network response was not ok');
                }
                // If response is ok, parse it as JSON
                return response.json();
            })
            .then(stage => {
                console.log("stage:", stage);

                // Convert timestamps in the JSON object
                stage.values.forEach(entry => {
                    entry[0] = formatNWSDate(entry[0]); // Update timestamp
                });

                // Output the updated JSON object
                // // console.log(JSON.stringify(stage, null, 2));

                // console.log("stageFormatted = ", stage);

                // Get the last non-null value from the stage data
                const lastNonNullValue = getLastNonNullValue(stage);
                // console.log("lastNonNullValue:", lastNonNullValue);

                // Check if a non-null value was found
                if (lastNonNullValue !== null) {
                    // Extract timestamp, value, and quality code from the last non-null value
                    var timestampLast = lastNonNullValue.timestamp;
                    var valueLast = parseFloat(lastNonNullValue.value).toFixed(0);
                    var qualityCodeLast = lastNonNullValue.qualityCode;

                    // Log the extracted valueLasts
                    // console.log("timestampLast:", timestampLast);
                    // console.log("valueLast:", valueLast);
                    // console.log("qualityCodeLast:", qualityCodeLast);
                } else {
                    // If no non-null valueLast is found, log a message
                    // console.log("No non-null valueLast found.");
                }

                // Format the last valueLast's timestampLast to a string
                const formattedLastValueTimeStamp = formatTimestampToString(timestampLast);
                // console.log("formattedLastValueTimeStamp = ", formattedLastValueTimeStamp);

                // Create a Date object from the timestampLast
                const timeStampDateObject = new Date(timestampLast);
                // console.log("timeStampDateObject = ", timeStampDateObject);

                // Subtract 24 hours (24 * 60 * 60 * 1000 milliseconds) from the timestampLast date
                const timeStampDateObjectMinus24Hours = new Date(timestampLast - (24 * 60 * 60 * 1000));
                // console.log("timeStampDateObjectMinus24Hours = ", timeStampDateObjectMinus24Hours);

                document.getElementById('usace_maximum').value = valueLast;

            })
            .catch(error => {
                // Catch and log any errors that occur during fetching or processing
                console.error("Error fetching or processing data:", error);
            });

    }

    function fetchUsaceMaximumPowerInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours) {
        // Fetch the time series data from the API using the determined query string
        let urlStage = null;
        urlStage = `https://coe-${office}uwa04${office.toLocaleLowerCase()}.${office.toLocaleLowerCase()}.usace.army.mil/${office.toLocaleLowerCase()}-data/timeseries?name=Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-maximum&begin=${currentDateTimeMinus30Hours.toISOString()}&end=${currentDateTime.toISOString()}&office=${office}`;

        // console.log("urlStage = ", urlStage);
        fetch(urlStage, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;version=2'
            }
        })
            .then(response => {
                // Check if the response is ok
                if (!response.ok) {
                    // If not, throw an error
                    throw new Error('Network response was not ok');
                }
                // If response is ok, parse it as JSON
                return response.json();
            })
            .then(stage => {
                console.log("stage:", stage);

                // Convert timestamps in the JSON object
                stage.values.forEach(entry => {
                    entry[0] = formatNWSDate(entry[0]); // Update timestamp
                });

                // Output the updated JSON object
                // // console.log(JSON.stringify(stage, null, 2));

                // console.log("stageFormatted = ", stage);

                // Get the last non-null value from the stage data
                const lastNonNullValue = getLastNonNullValue(stage);
                // console.log("lastNonNullValue:", lastNonNullValue);

                // Check if a non-null value was found
                if (lastNonNullValue !== null) {
                    // Extract timestamp, value, and quality code from the last non-null value
                    var timestampLast = lastNonNullValue.timestamp;
                    var valueLast = parseFloat(lastNonNullValue.value).toFixed(0);
                    var qualityCodeLast = lastNonNullValue.qualityCode;

                    // Log the extracted valueLasts
                    // console.log("timestampLast:", timestampLast);
                    // console.log("valueLast:", valueLast);
                    // console.log("qualityCodeLast:", qualityCodeLast);
                } else {
                    // If no non-null valueLast is found, log a message
                    // console.log("No non-null valueLast found.");
                }

                // Format the last valueLast's timestampLast to a string
                const formattedLastValueTimeStamp = formatTimestampToString(timestampLast);
                // console.log("formattedLastValueTimeStamp = ", formattedLastValueTimeStamp);

                // Create a Date object from the timestampLast
                const timeStampDateObject = new Date(timestampLast);
                // console.log("timeStampDateObject = ", timeStampDateObject);

                // Subtract 24 hours (24 * 60 * 60 * 1000 milliseconds) from the timestampLast date
                const timeStampDateObjectMinus24Hours = new Date(timestampLast - (24 * 60 * 60 * 1000));
                // console.log("timeStampDateObjectMinus24Hours = ", timeStampDateObjectMinus24Hours);

                document.getElementById('usace_maximum_power').value = valueLast;

            })
            .catch(error => {
                // Catch and log any errors that occur during fetching or processing
                console.error("Error fetching or processing data:", error);
            });

    }

    fetchUsaceMaximumInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours);
    fetchUsaceMaximumPowerInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours);

    function fetchUsaceMinimumInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours) {
        // Fetch the time series data from the API using the determined query string
        let urlStage = null;
        urlStage = `https://wm.${office.toLocaleLowerCase()}.ds.usace.army.mil/${office.toLowerCase()}-data/timeseries?name=Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-minimum&begin=${currentDateTimeMinus30Hours.toISOString()}&end=${currentDateTime.toISOString()}&office=${office}`;

        fetch(urlStage, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;version=2'
            }
        })
            .then(response => {
                // Check if the response is ok
                if (!response.ok) {
                    // If not, throw an error
                    throw new Error('Network response was not ok');
                }
                // If response is ok, parse it as JSON
                return response.json();
            })
            .then(stage => {
                console.log("stage:", stage);

                // Convert timestamps in the JSON object
                stage.values.forEach(entry => {
                    entry[0] = formatNWSDate(entry[0]); // Update timestamp
                });

                // Get the last non-null value from the stage data
                const lastNonNullValue = getLastNonNullValue(stage);

                // Check if a non-null value was found
                if (lastNonNullValue !== null) {
                    // Extract timestamp, value, and quality code from the last non-null value
                    var timestampLast = lastNonNullValue.timestamp;
                    var valueLast = parseFloat(lastNonNullValue.value).toFixed(0);
                    var qualityCodeLast = lastNonNullValue.qualityCode;
                }

                // Format the last valueLast's timestampLast to a string
                const formattedLastValueTimeStamp = formatTimestampToString(timestampLast);

                // Create a Date object from the timestampLast
                const timeStampDateObject = new Date(timestampLast);

                // Subtract 24 hours (24 * 60 * 60 * 1000 milliseconds) from the timestampLast date
                const timeStampDateObjectMinus24Hours = new Date(timestampLast - (24 * 60 * 60 * 1000));

                document.getElementById('usace_minimum').value = valueLast;

            })
            .catch(error => {
                // Catch and log any errors that occur during fetching or processing
                console.error("Error fetching or processing data:", error);
            });
    }

    function fetchUsaceMinimumPowerInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours) {
        // Fetch the time series data from the API using the determined query string
        let urlStage = null;
        urlStage = `https://wm.${office.toLocaleLowerCase()}.ds.usace.army.mil/${office.toLowerCase()}-data/timeseries?name=Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-minimum&begin=${currentDateTimeMinus30Hours.toISOString()}&end=${currentDateTime.toISOString()}&office=${office}`;

        fetch(urlStage, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;version=2'
            }
        })
            .then(response => {
                // Check if the response is ok
                if (!response.ok) {
                    // If not, throw an error
                    throw new Error('Network response was not ok');
                }
                // If response is ok, parse it as JSON
                return response.json();
            })
            .then(stage => {
                console.log("stage:", stage);

                // Convert timestamps in the JSON object
                stage.values.forEach(entry => {
                    entry[0] = formatNWSDate(entry[0]); // Update timestamp
                });

                // Get the last non-null value from the stage data
                const lastNonNullValue = getLastNonNullValue(stage);

                // Check if a non-null value was found
                if (lastNonNullValue !== null) {
                    // Extract timestamp, value, and quality code from the last non-null value
                    var timestampLast = lastNonNullValue.timestamp;
                    var valueLast = parseFloat(lastNonNullValue.value).toFixed(0);
                    var qualityCodeLast = lastNonNullValue.qualityCode;
                }

                // Format the last valueLast's timestampLast to a string
                const formattedLastValueTimeStamp = formatTimestampToString(timestampLast);

                // Create a Date object from the timestampLast
                const timeStampDateObject = new Date(timestampLast);

                // Subtract 24 hours (24 * 60 * 60 * 1000 milliseconds) from the timestampLast date
                const timeStampDateObjectMinus24Hours = new Date(timestampLast - (24 * 60 * 60 * 1000));

                document.getElementById('usace_minimum_power').value = valueLast;

            })
            .catch(error => {
                // Catch and log any errors that occur during fetching or processing
                console.error("Error fetching or processing data:", error);
            });
    }

    fetchUsaceMinimumInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours);
    fetchUsaceMinimumPowerInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours);

    function fetchUsaceTargetInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours) {
        // Fetch the time series data from the API using the determined query string
        let urlStage = null;
        urlStage = `https://wm.${office.toLocaleLowerCase()}.ds.usace.army.mil/${office.toLowerCase()}-data/timeseries?name=Mark Twain Lk-Salt.Flow.Ave.~1Day.1Day.usace-target&begin=${currentDateTimeMinus30Hours.toISOString()}&end=${currentDateTime.toISOString()}&office=${office}`;

        fetch(urlStage, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;version=2'
            }
        })
            .then(response => {
                // Check if the response is ok
                if (!response.ok) {
                    // If not, throw an error
                    throw new Error('Network response was not ok');
                }
                // If response is ok, parse it as JSON
                return response.json();
            })
            .then(stage => {
                console.log("stage:", stage);

                // Convert timestamps in the JSON object
                stage.values.forEach(entry => {
                    entry[0] = formatNWSDate(entry[0]); // Update timestamp
                });

                // Get the last non-null value from the stage data
                const lastNonNullValue = getLastNonNullValue(stage);

                // Check if a non-null value was found
                if (lastNonNullValue !== null) {
                    // Extract timestamp, value, and quality code from the last non-null value
                    var timestampLast = lastNonNullValue.timestamp;
                    var valueLast = parseFloat(lastNonNullValue.value).toFixed(0);
                    var qualityCodeLast = lastNonNullValue.qualityCode;
                }

                // Format the last valueLast's timestampLast to a string
                const formattedLastValueTimeStamp = formatTimestampToString(timestampLast);

                // Create a Date object from the timestampLast
                const timeStampDateObject = new Date(timestampLast);

                // Subtract 24 hours (24 * 60 * 60 * 1000 milliseconds) from the timestampLast date
                const timeStampDateObjectMinus24Hours = new Date(timestampLast - (24 * 60 * 60 * 1000));

                document.getElementById('usace_target').value = valueLast;

            })
            .catch(error => {
                // Catch and log any errors that occur during fetching or processing
                console.error("Error fetching or processing data:", error);
            });
    }

    function fetchUsaceTargetPowerInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours) {
        // Fetch the time series data from the API using the determined query string
        let urlStage = null;
        urlStage = `https://wm.${office.toLocaleLowerCase()}.ds.usace.army.mil/${office.toLowerCase()}-data/timeseries?name=Mark Twain Lk-Salt.Power.Ave.~1Day.1Day.usace-target&begin=${currentDateTimeMinus30Hours.toISOString()}&end=${currentDateTime.toISOString()}&office=${office}`;

        fetch(urlStage, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;version=2'
            }
        })
            .then(response => {
                // Check if the response is ok
                if (!response.ok) {
                    // If not, throw an error
                    throw new Error('Network response was not ok');
                }
                // If response is ok, parse it as JSON
                return response.json();
            })
            .then(stage => {
                console.log("stage:", stage);

                // Convert timestamps in the JSON object
                stage.values.forEach(entry => {
                    entry[0] = formatNWSDate(entry[0]); // Update timestamp
                });

                // Get the last non-null value from the stage data
                const lastNonNullValue = getLastNonNullValue(stage);

                // Check if a non-null value was found
                if (lastNonNullValue !== null) {
                    // Extract timestamp, value, and quality code from the last non-null value
                    var timestampLast = lastNonNullValue.timestamp;
                    var valueLast = parseFloat(lastNonNullValue.value).toFixed(0);
                    var qualityCodeLast = lastNonNullValue.qualityCode;
                }

                // Format the last valueLast's timestampLast to a string
                const formattedLastValueTimeStamp = formatTimestampToString(timestampLast);

                // Create a Date object from the timestampLast
                const timeStampDateObject = new Date(timestampLast);

                // Subtract 24 hours (24 * 60 * 60 * 1000 milliseconds) from the timestampLast date
                const timeStampDateObjectMinus24Hours = new Date(timestampLast - (24 * 60 * 60 * 1000));

                document.getElementById('usace_target_power').value = valueLast;

            })
            .catch(error => {
                // Catch and log any errors that occur during fetching or processing
                console.error("Error fetching or processing data:", error);
            });
    }

    fetchUsaceTargetInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours);
    fetchUsaceTargetPowerInput(currentDateTimeMinus2Hours, currentDateTime, currentDateTimeMinus30Hours);
</script>

<script>
    function prepareEmail(event) {
        // Prevent the form from submitting
        event.preventDefault();

        // Function to adjust values
        const adjustValue = (value) => (value === "0") ? "na" : value;

        // Gather and adjust form data
        const swpaScheduledGeneration = (document.getElementById('swpa_scheduled_generation').value);
        const swpaScheduledGenerationPower = (document.getElementById('swpa_scheduled_generation_power').value);
        const usaceMaximum = (document.getElementById('usace_maximum').value);
        const usaceMaximumPower = (document.getElementById('usace_maximum_power').value);

        const usaceMinimum = adjustValue(document.getElementById('usace_minimum').value);
        const usaceMinimumPower = adjustValue(document.getElementById('usace_minimum_power').value);
        const usaceTarget = adjustValue(document.getElementById('usace_target').value);
        const usaceTargetPower = adjustValue(document.getElementById('usace_target_power').value);

        // Get current date in MM/DD/YYYY format
        const currentDate = new Date();
        const options = { month: '2-digit', day: '2-digit', year: 'numeric' };
        const formattedDate = currentDate.toLocaleDateString('en-US', options);

        // Create the email subject
        const subject = `Cannon Requirements ${formattedDate}`;

        // Create the email body
        const body = `SWPA’s Scheduled Generation: ${swpaScheduledGeneration} (dsf) ${swpaScheduledGenerationPower} (MW)\n\n` +
            `USACE Maximum: ${usaceMaximum} (dsf) ${usaceMaximumPower} (MW)\n\n` +
            `USACE Minimum: ${usaceMinimum} (dsf) ${usaceMinimumPower} (MW)\n\n` +
            `USACE Target: ${usaceTarget} (dsf) ${usaceTargetPower} (MW)`;

        // Set the recipient email address
        // const to = 'ivan.h.nguyen@usace.army.mil;allen.phillips@usace.army.mil;DLL-CEMVS-WATER-MANAGERS@usace.army.mil';
        const to = 'ivan.h.nguyen@usace.army.mil;allen.phillips@usace.army.mil;DLL-CEMVS-WATER-MANAGERS@usace.army.mil;dll-cemvk-blakely-senior-controllers@usace.army.mil;resources@swpa.gov;larry.j.hurt@usace.army.mil;michael.d.tate@usace.army.mil';

        // Create a mailto link
        const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

        // Open the mailto link in the default email client
        window.location.href = mailtoLink;
    }
</script>

</html>